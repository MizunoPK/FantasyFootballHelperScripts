# Historical Data Compiler Script

## Objective
Create a standalone script to compile historical NFL season data for use in the simulation system. The script fetches data from the ESPN Fantasy API and creates point-in-time snapshots representing what the system would "see" during each week of a given season.

---

## High-Level Requirements

### 1. Script Location and Execution
- **Script name:** `compile_historical_data.py` (root level, standalone)
- **Input source:** ESPN Fantasy API (single data source)
- **Output destination:** `simulation/sim_data/{YEAR}/`
- **Usage:** `python compile_historical_data.py --year 2024`

### 2. Output Folder Structure
```
simulation/sim_data/{YEAR}/
├── season_schedule.csv          # Full season schedule (all 17 weeks)
├── game_data.csv                # Game results and conditions for all weeks
├── team_data/                   # Team defensive stats by week
│   ├── ARI.csv
│   ├── ATL.csv
│   └── ... (32 team files)
└── weeks/
    ├── week_01/
    │   ├── players.csv          # Actual player stats through week 1
    │   └── players_projected.csv # Projections as of week 1
    ├── week_02/
    │   ├── players.csv
    │   └── players_projected.csv
    └── ... (weeks 01-17)
```

### 3. Data Source (ESPN Fantasy API)
**Single data source for all player data:**
- **API Endpoint:** `https://lm-api-reads.fantasy.espn.com/apis/v3/games/ffl/seasons/{YEAR}/segments/0/leaguedefaults/3`
- **Weekly data:** Use `scoringPeriodId` parameter (1-17)
- **Actual points:** `statSourceId=0, appliedTotal`
- **Projected points:** `statSourceId=1, appliedTotal`
- **Positions:** QB, RB, WR, TE, K, DST (all 6 fantasy-relevant)
- **Years supported:** 2021+ (verified)

### 4. Point-in-Time Data Concept
Each week folder represents a "snapshot" of what the system would know at that point:

**players.csv (Actual Stats):**
- Week 1 folder: Contains only week 1 actual results
- Week 5 folder: Contains cumulative stats through week 5
- Bye weeks shown as 0.0 points for that week

**players_projected.csv (Projections):**
- Contains projected points for remaining weeks of season
- Week 1: Has projections for weeks 1-17
- Week 5: Has projections for weeks 5-17 (actual data for 1-4)

### 5. File Formats

**players.csv / players_projected.csv:**
```csv
id,name,team,position,bye_week,fantasy_points,injury_status,drafted,locked,average_draft_position,player_rating,week_1_points,week_2_points,...,week_17_points
```

**season_schedule.csv:**
```csv
week,team,opponent
1,ARI,BUF
1,ATL,PIT
...
```

**game_data.csv:**
```csv
week,home_team,away_team,temperature,gust,precipitation,home_team_score,away_team_score,indoor,neutral_site,country,city,state,date
```

**team_data/{TEAM}.csv:**
```csv
week,pts_allowed_to_QB,pts_allowed_to_RB,pts_allowed_to_WR,pts_allowed_to_TE,pts_allowed_to_K,points_scored,points_allowed
```

---

## Open Questions (To Be Resolved)

### Data Sourcing Questions

1. **Schedule Data Source:** ✓ RESOLVED
   - ESPN Scoreboard API (reuse ScheduleFetcher.py logic)

2. **Game Data Source:** ✓ RESOLVED
   - Game scores: ESPN Scoreboard API
   - Weather data: Open-Meteo Archive/Forecast API
   - Venue info: ESPN Scoreboard API
   - See "game_data.csv Implementation" section below

3. **Team Defense Stats:** ✓ RESOLVED
   - Aggregate from player fantasy points vs opponent
   - Single-week values (not cumulative)
   - See "team_data.csv Implementation" section below

4. **Bye Week Detection:** ✓ RESOLVED
   - Derived from season schedule (team missing from week = bye)
   - See season_schedule.csv implementation

5. **Player Metadata:** ✓ RESOLVED
   - ADP: ESPN API `ownership.averageDraftPosition`
   - player_rating: Calculated (Week 1: draft rank; Week 2+: fantasy_points ranking)

### Processing Questions

6. **Fantasy Points Calculation:** ✓ RESOLVED
   - Use ESPN `appliedTotal` directly (PPR scoring)
   - No recalculation needed

7. **Injury Status:** ✓ RESOLVED
   - Default to "ACTIVE" (historical injury data not reliably available)

8. **Player Filtering:** ✓ RESOLVED
   - Include fantasy-relevant positions: QB, RB, WR, TE, K, DST
   - DST = team defense/special teams (e.g., "Broncos D/ST")
   - Individual defensive players (LB, DL, DB) NOT included
   - **Filter by activity:** Only include players with at least 1 game or projected points

9. **Player ID Consistency:** ✓ RESOLVED
   - Use ESPN player IDs (consistent with single data source approach)

10. **Cumulative vs Weekly Stats:** ✓ RESOLVED
    - Each week folder has week columns 1-17
    - Past weeks: actual points; Current/future weeks: projected points
    - See week column logic in Implementation Details

### Technical Questions

11. **Years to Support Initially:** ✓ RESOLVED
    - Support 2021+ only (weekly data required)
    - 2015-2020 not supported (aggregated data only, no weekly breakdown)
    - Start with 2024 for testing, then expand to 2021-2023

12. **Weeks Count:** ✓ RESOLVED
    - Using weeks 1-17 (full regular season)
    - NFL has had 17 regular season weeks since 2021

13. **Error Handling:** ✓ RESOLVED
    - **Fail loudly:** Stop execution and report error for manual review
    - Skip players with no projections entirely
    - Incomplete data should cause script to fail (not silently skip)

---

## Resolved Implementation Details

### players_projected.csv - Week Column Logic

**Source:** ESPN Fantasy API
**Field used:** `statSourceId=1, appliedTotal` (weekly projection for that specific week)

For `week_XX/players_projected.csv` (file created at Week X), populate week columns as follows:

| Condition | Value | Source |
|-----------|-------|--------|
| **Bye week** | `0` | Always zero, regardless of week X |
| **Week < X** | Historical projection | ESPN API for that week (`statSourceId=1`) |
| **Week >= X** | Current projection | ESPN API for Week X (`statSourceId=1`) |

**Example: `week_05/players_projected.csv` for player with bye in Week 7:**

```
week_1_points = 21.14  # From week 1 projected file
week_2_points = 19.50  # From week 2 projected file
week_3_points = 20.00  # From week 3 projected file
week_4_points = 18.75  # From week 4 projected file
week_5_points = 22.00  # From week 5 projected file (current)
week_6_points = 22.00  # From week 5 projected file (>= X, use current)
week_7_points = 0      # BYE WEEK (always 0)
week_8_points = 22.00  # From week 5 projected file (>= X, use current)
...
week_17_points = 22.00 # From week 5 projected file (>= X, use current)
```

**Rationale:** This creates a true point-in-time view. For past weeks, we use what was actually projected at the time. For current/future weeks, we use the best available projection (current week). Bye weeks are always 0 since the player doesn't play.

**VERIFIED:** ESPN API preserves week-specific historical projections (tested Dec 2024):
- Projections vary by week (e.g., Lamar Jackson: W1=20.23, W10=23.87)
- All weeks 1-17 have unique projection values per player
- Use `scoringPeriodId=0` with `view=kona_player_info` to fetch all weeks at once

### players.csv - Week Column Logic

**Sources:** ESPN Fantasy API
- Actual data: `statSourceId=0, appliedTotal`
- Projected data: `statSourceId=1, appliedTotal`

For `week_XX/players.csv` (file created at Week X), populate week columns as follows:

| Condition | Value | Source |
|-----------|-------|--------|
| **Bye week** | `0` | Always zero, regardless of week X |
| **Week < X** | Actual points | ESPN API for that week (`statSourceId=0`) |
| **Week >= X** | Projected points | ESPN API for Week X (`statSourceId=1`) |

**Example: `week_05/players.csv` for player with bye in Week 7:**

```
week_1_points = 31.18  # From week 1 ESPN API (statSourceId=0)
week_2_points = 24.50  # From week 2 ESPN API (statSourceId=0)
week_3_points = 19.00  # From week 3 ESPN API (statSourceId=0)
week_4_points = 28.75  # From week 4 ESPN API (statSourceId=0)
week_5_points = 22.00  # From week 5 ESPN API (statSourceId=1, projection)
week_6_points = 22.00  # From week 5 ESPN API (statSourceId=1, projection)
week_7_points = 0      # BYE WEEK (always 0)
week_8_points = 22.00  # From week 5 ESPN API (statSourceId=1, projection)
...
week_17_points = 22.00 # From week 5 ESPN API (statSourceId=1, projection)
```

**Rationale:** This creates a point-in-time view where past weeks show actual results (what really happened) and current/future weeks show the best available forecast. Bye weeks are always 0 since the player doesn't play.

**Key difference from players_projected.csv:** Past weeks use ACTUAL points here, not historical projections.

### fantasy_points Field (Both Files)

**Calculation:** `fantasy_points = sum(week_1_points, week_2_points, ..., week_17_points)`

Simply sum all 17 week columns. This applies to both `players.csv` and `players_projected.csv`.

### bye_week Field (Both Files)

**Source:** `season_schedule.csv`

**Logic:**
1. Load the season schedule (generated via ESPN API / ScheduleFetcher logic)
2. For each team, find the week where opponent is empty (bye week)
3. For each player, lookup their team's bye week

**Example:**
- Player is on team `KC`
- In `season_schedule.csv`, KC has empty opponent in week 6
- Player's `bye_week` = `6`

### player_rating Field (Both Files)

**Source:** ESPN API (single data source approach)

**Week 1 Logic:**
- Use ESPN `draftRanksByRankType.PPR.rank` (overall draft rank)
- Normalize to position-specific 1-100 scale

**Week 2+ Logic:**
- Calculate from cumulative `fantasy_points` through that week
- Sort players by fantasy_points within each position
- Higher points = higher rating (100 = best performer, 1 = worst)

**Normalization Formula (both cases):**
```
For each position:
  1. Rank players (by draft rank for week 1, by fantasy_points for week 2+)
  2. position_rank = player's rank within their position (1 = best)
  3. total_in_position = count of players at that position
  4. player_rating = max(1, 100 - ((position_rank - 1) / total_in_position) * 99)
```

**Example - Week 5 RBs:**
| Player | Cumulative Points | Position Rank | player_rating |
|--------|------------------|---------------|---------------|
| Derrick Henry | 135.1 | 1 | 100 |
| Saquon Barkley | 128.4 | 2 | 98 |
| ... | ... | ... | ... |
| Backup RB | 12.3 | 50 | 2 |

**Notes:**
- Ratings are position-specific (compares QBs to QBs, RBs to RBs, etc.)
- Week 1 uses pre-season expectations (draft rank)
- Week 2+ uses actual performance (rewards production)
- All data from ESPN API - no NFL-Data dependency for this field

### average_draft_position Field (Both Files)

**Source:** ESPN Fantasy API (same as `player-data-fetcher`)

**API Endpoint:**
```
https://lm-api-reads.fantasy.espn.com/apis/v3/games/ffl/seasons/{YEAR}/segments/0/leaguedefaults/3
```

**Field:** `player.ownership.averageDraftPosition`

**Implementation:**
1. Query ESPN API with the target season year
2. Extract `averageDraftPosition` from each player's `ownership` object
3. Use this value directly for the `average_draft_position` field

**Verified:** Test script confirmed:
- Rookie players (e.g., Ashton Jeanty) do NOT appear in previous seasons
- ADP values differ by year (e.g., Rashee Rice: 167.7 in 2024 → 54.7 in 2025)

**Note:** Can reuse logic from `player-data-fetcher/espn_client.py` for API calls.

### ESPN API Weekly Data (All Positions)

**VERIFIED:** ESPN API provides weekly actual + projected data for ALL fantasy positions (tested Dec 2024):

| Position | Slot ID | Position ID | Weekly Actual | Weekly Projected |
|----------|---------|-------------|---------------|------------------|
| QB | 0 | 1 | ✓ | ✓ |
| RB | 2 | 2 | ✓ | ✓ |
| WR | 4 | 3 | ✓ | ✓ |
| TE | 6 | 4 | ✓ | ✓ |
| K | 17 | 5 | ✓ | ✓ |
| DST | 16 | 16 | ✓ | ✓ |

**Key Findings:**
- All 6 positions have full weekly data available
- Bye weeks correctly show as null/0 for actuals
- Negative values supported (DST can have negative scores)
- Use `filterSlotIds` in X-Fantasy-Filter header for position filtering
- `statSourceId=0` = actual scores, `statSourceId=1` = projections

**This means we can get ALL player data from ESPN API instead of NFL-Data!**
- Simplifies implementation (single data source)
- Consistent data format across all positions
- Includes DST which NFL-Data doesn't have

### DST (Defense/Special Teams) Data

**Source:** ESPN Fantasy API (NOT NFL-Data)

**Key Details:**
- NFL-Data only has individual defensive players (DB, DL, LB) - no team DST
- ESPN API provides DST as position ID 16
- DST entries use negative player IDs (e.g., -16007 for Broncos D/ST)
- Names follow format: "{Team} D/ST" (e.g., "Broncos D/ST", "Texans D/ST")
- Weekly fantasy points available (can be negative for poor performances)

**VERIFIED:** Weekly DST data confirmed available from ESPN API (tested Dec 2024):
- ✓ Weekly actual scores (statSourceId=0)
- ✓ Weekly projections (statSourceId=1)
- ✓ Negative values returned correctly (e.g., Week 9 Broncos: -3.0)
- ✓ All 32 teams available

**Example - Broncos D/ST 2024:**
| Week | Actual | Projected |
|------|--------|-----------|
| 1 | 10.0 | 4.5 |
| 5 | 15.0 | 7.6 |
| 9 | -3.0 | 4.1 |

**Implementation:**
- Fetch DST data alongside other positions from ESPN API
- Use same logic as `player-data-fetcher/espn_client.py`
- DST players get bye weeks from team schedule like other positions
- Filter by position ID 16 in X-Fantasy-Filter header

### game_data.csv Implementation

**Data Sources:**
1. **ESPN Scoreboard API** - Game info, scores, venue
2. **Open-Meteo Weather API** - Temperature, wind, precipitation
3. **coordinates.json** - Stadium lat/lon for weather lookups

**ESPN Scoreboard API:**
```
Endpoint: https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard
Parameters: seasontype=2, week={1-17}, dates={YEAR}
```

**Open-Meteo Weather APIs:**
```
Historical (>5 days old): https://archive-api.open-meteo.com/v1/archive
Forecast (<5 days): https://api.open-meteo.com/v1/forecast
Parameters: latitude, longitude, hourly=temperature_2m,wind_gusts_10m,precipitation
Units: fahrenheit, mph, inch
```

**Field Mappings:**

| Field | ESPN API Path | Notes |
|-------|--------------|-------|
| `week` | Request parameter | 1-17 |
| `home_team` | `competitions[0].competitors[].team.abbreviation` | where `homeAway=home` |
| `away_team` | `competitions[0].competitors[].team.abbreviation` | where `homeAway=away` |
| `home_team_score` | `competitions[0].competitors[].score` | where `homeAway=home` |
| `away_team_score` | `competitions[0].competitors[].score` | where `homeAway=away` |
| `indoor` | `competitions[0].venue.indoor` | Boolean |
| `neutral_site` | `competitions[0].neutralSite` | Boolean |
| `country` | `competitions[0].venue.address.country` | Default: "USA" |
| `city` | `competitions[0].venue.address.city` | |
| `state` | `competitions[0].venue.address.state` | None for international |
| `date` | `event.date` | ISO 8601 format |
| `temperature` | Open-Meteo `temperature_2m` | At game hour, None if indoor |
| `gust` | Open-Meteo `wind_gusts_10m` | At game hour, None if indoor |
| `precipitation` | Open-Meteo `precipitation` | At game hour, None if indoor |

**Weather Logic:**
- Skip weather fetch for indoor games (return None for weather fields)
- Use stadium coordinates from `coordinates.json` for lat/lon
- Use game date to select API (Archive for historical, Forecast for recent)
- Find hourly data closest to game start time
- International venues use geocoding API to get coordinates (cached)

**Reusable Code:**
Adapt logic from `player-data-fetcher/game_data_fetcher.py`:
- `_fetch_espn_scoreboard(week)` - ESPN API calls
- `_fetch_weather_for_game(...)` - Weather API calls
- `GameData.from_espn_data(...)` - Data parsing
- `CoordinatesManager` - Stadium coordinate lookups

**Verified:** Test confirmed 2024 vs 2025 return different data (different matchups, dates, scores).

### team_data.csv Implementation

**Data Source:** Calculated from ESPN player fantasy points data

**Algorithm:** (from `player-data-fetcher/espn_client.py:_collect_team_weekly_data()`)

```
For each team and each week:
  1. Initialize: pts_allowed_to_{QB,RB,WR,TE,K} = 0, points_scored = 0, points_allowed = 0

  2. For each player in league:
     - Get player's fantasy points for this week
     - Add to player's team's points_scored
     - Find opponent from schedule
     - Add to opponent's pts_allowed_to_{player.position}
     - Add to opponent's points_allowed

  3. Round all values to 1 decimal place
```

**Formula:**
```
pts_allowed_to_{POS}[Team_A, Week_N] = SUM(fantasy_points[Player, Week_N])
    WHERE Player.position = {POS}
    AND Player played AGAINST Team_A in Week_N

points_scored[Team_A, Week_N] = SUM(fantasy_points[Player, Week_N])
    WHERE Player.team = Team_A

points_allowed[Team_A, Week_N] = SUM(fantasy_points[Player, Week_N])
    WHERE Player played AGAINST Team_A in Week_N
```

**Required Inputs:**
1. Player weekly fantasy points (from ESPN API)
2. Player position and team (from ESPN API)
3. Season schedule with opponents (from ESPN Scoreboard API)

**Bye Week Handling:**
- Include row with 0s for all fields during bye week

**Output Format:**
```csv
week,pts_allowed_to_QB,pts_allowed_to_RB,pts_allowed_to_WR,pts_allowed_to_TE,pts_allowed_to_K,points_scored,points_allowed
1,27.9,8.1,60.2,0.0,9.0,100.4,105.2
2,11.5,17.4,18.4,0.0,12.0,55.8,59.3
...
```

**Reusable Code:**
Adapt `player-data-fetcher/espn_client.py:_collect_team_weekly_data()` method which already implements this exact algorithm.

---

## Implementation Notes

### Team Abbreviation Handling (VERIFIED)

**Canonical 32-team abbreviation list:**
```
ARI, ATL, BAL, BUF, CAR, CHI, CIN, CLE, DAL, DEN, DET, GB,
HOU, IND, JAX, KC, LAC, LAR, LV, MIA, MIN, NE, NO, NYG,
NYJ, PHI, PIT, SEA, SF, TB, TEN, WSH
```

**How APIs return team info:**
| API | Returns | Notes |
|-----|---------|-------|
| ESPN Scoreboard | Abbreviations directly | Uses WSH for Washington (2021+) |
| ESPN Fantasy | Numeric `proTeamId` | We control mapping via `ESPN_TEAM_MAPPINGS` |

**ESPN Team ID Mapping** (from `player_data_constants.py`):
```python
ESPN_TEAM_MAPPINGS = {
    1: 'ATL', 2: 'BUF', 3: 'CHI', 4: 'CIN', 5: 'CLE', 6: 'DAL',
    7: 'DEN', 8: 'DET', 9: 'GB', 10: 'TEN', 11: 'IND', 12: 'KC',
    13: 'LV', 14: 'LAR', 15: 'MIA', 16: 'MIN', 17: 'NE', 18: 'NO',
    19: 'NYG', 20: 'NYJ', 21: 'PHI', 22: 'ARI', 23: 'PIT', 24: 'LAC',
    25: 'SF', 26: 'SEA', 27: 'TB', 28: 'WSH', 29: 'CAR', 30: 'JAX',
    33: 'BAL', 34: 'HOU'
}
```

**Normalization function (use if external data has WAS):**
```python
def normalize_team(abbrev: str) -> str:
    return 'WSH' if abbrev == 'WAS' else abbrev
```

**VERIFIED (Dec 2024):**
- All 32 teams have identical abbreviations across years 2021-2024
- ESPN Scoreboard API uses WSH for Washington in all tested years
- No year-specific variations or relocations to handle for 2021+

### Dependencies
- `httpx` for async HTTP requests (same as player-data-fetcher)
- Standard library (csv, json, pathlib, asyncio)
- Optional: pandas for data processing efficiency

### Data Transformations Required
1. Fetch player data from ESPN API for each week
2. Map ESPN field names to sim_data format
3. Calculate/derive bye weeks from schedule
4. Calculate team defensive stats from player game logs
5. Generate season_schedule from ESPN scoreboard API

### Testing Strategy
- Compare output with existing sim_data structure
- Validate row counts and data integrity
- Spot-check specific players/weeks for accuracy

---

## Next Steps
1. ~~Resolve open questions above~~ ✓ ALL RESOLVED
2. Create detailed TODO file for implementation
3. Build script incrementally with testing
4. Validate against 2024 season data
5. Test with additional seasons (2021-2023)

**Status: READY FOR IMPLEMENTATION** - All data sources and algorithms are defined.
