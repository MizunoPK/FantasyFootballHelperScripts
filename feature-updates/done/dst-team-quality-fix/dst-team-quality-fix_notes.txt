# Feature Request: Fix D/ST Team Quality Calculation

## Problem Statement

The team quality multiplier (Step 4 of the scoring algorithm) uses an incorrect metric for D/ST positions, resulting in elite fantasy defenses being rated as "VERY_POOR" while they should be "EXCELLENT".

## Current Behavior (INCORRECT)

For D/ST positions, the system:
1. Uses `team_defensive_rank` from TeamDataManager
2. This rank is calculated from `points_allowed` in team_data/*.csv
3. `points_allowed` = total fantasy points allowed to ALL opposing players (QB+RB+WR+TE+K)
4. Higher points allowed → worse defensive rank → lower team quality multiplier

Example: Houston Texans D/ST
- Week 15: Allowed 116.6 fantasy points to opponents
- Defensive rank: 24th out of 32 teams
- Team quality rating: VERY_POOR (0.95x multiplier)
- **BUT**: Houston D/ST scored 6.0 fantasy points in week 15, ranked 9th
- **Season-long**: Houston D/ST averages 9.34 ppg, ranked #2 in the entire league!

## Root Cause

The `points_allowed` metric measures how well the opposing offense performs against the team, NOT how well the D/ST unit performs in fantasy football.

- High `points_allowed` = Good opposing offenses (irrelevant to D/ST fantasy value)
- Low `points_allowed` = Bad opposing offenses (also irrelevant)

D/ST fantasy scoring is based on:
- Sacks, interceptions, fumbles recovered
- Defensive/Special teams touchdowns
- Points allowed (real NFL points, not fantasy points)
- Safety, blocked kicks, etc.

## Desired Behavior (CORRECT)

For D/ST positions, the team quality multiplier should be based on:
- **D/ST fantasy points SCORED** (from players.csv weekly_points data)
- Ranking D/ST units by their actual fantasy performance
- Higher fantasy points scored → better rank → higher team quality multiplier

Example with fix: Houston Texans D/ST
- Season average: 9.34 ppg
- Rank: #2 out of 32 teams
- Team quality rating: EXCELLENT (1.05x multiplier)

## Technical Details

### Current Implementation
**File**: `league_helper/util/player_scoring.py:519-533`
```python
def _apply_team_quality_multiplier(self, p: FantasyPlayer, player_score: float) -> Tuple[float, str]:
    """Apply team quality multiplier (Step 4)."""
    # Determine which team ranking to use based on player type
    quality_val = p.team_offensive_rank
    if p.position in Constants.DEFENSE_POSITIONS:  # ← DST uses defensive rank
        quality_val = p.team_defensive_rank        # ← WRONG METRIC

    multiplier, rating = self.config.get_team_quality_multiplier(quality_val)
    reason = f"Team Quality: {rating} ({multiplier:.2f}x)"
    return player_score * multiplier, reason
```

**File**: `league_helper/util/PlayerManager.py:199-202`
```python
# Load team quality rankings for scoring calculations
player.team_offensive_rank = self.team_data_manager.get_team_offensive_rank(player.team)
player.team_defensive_rank = self.team_data_manager.get_team_defensive_rank(player.team)
```

**File**: `league_helper/util/TeamDataManager.py:219-229`
```python
def _rank_defensive(self, totals: Dict[str, tuple]) -> None:
    """Rank teams by defensive production (fewer points allowed = better = rank 1)."""
    # Calculate per-game averages
    averages = []
    for team, (total, games) in totals.items():
        avg = total / games if games > 0 else float('inf')
        averages.append((team, avg))

    # Sort by average ascending (fewest points = rank 1)
    averages.sort(key=lambda x: x[1])
    # ← This ranks by points_allowed (total fantasy points to opponents)
```

### Proposed Solution

#### Option 1: Add D/ST-specific ranking calculation

Add a new ranking method to TeamDataManager:
- `get_dst_fantasy_rank(team)` - ranks teams by D/ST fantasy points scored
- Calculate from players.csv weekly D/ST scores
- Use rolling window (MIN_WEEKS) like other rankings

Modify player_scoring.py to use D/ST rank for DST positions:
```python
def _apply_team_quality_multiplier(self, p: FantasyPlayer, player_score: float) -> Tuple[float, str]:
    quality_val = p.team_offensive_rank
    if p.position in Constants.DEFENSE_POSITIONS:
        quality_val = p.team_dst_fantasy_rank  # NEW: D/ST-specific rank

    multiplier, rating = self.config.get_team_quality_multiplier(quality_val)
    reason = f"Team Quality: {rating} ({multiplier:.2f}x)"
    return player_score * multiplier, reason
```

#### Option 2: Disable team quality for D/ST

Simplest short-term fix:
- Return neutral multiplier (1.0x) for D/ST positions
- Skip team quality adjustment entirely for defenses
- Reasoning: D/ST fantasy value is already captured in their projected points

## Impact Analysis

### Affected Components
- `league_helper/util/player_scoring.py` - Team quality multiplier logic
- `league_helper/util/PlayerManager.py` - Ranking assignment
- `league_helper/util/TeamDataManager.py` - Ranking calculation (if Option 1)
- Tests that verify team quality scoring for D/ST positions

### Scoring Impact
With current (incorrect) implementation:
- Elite D/ST units (top 6) get penalized with 0.95x-1.0x multipliers
- Poor D/ST units (bottom 6) may get boosted with 1.0x-1.05x multipliers
- This creates backwards incentives for D/ST selection

With fix (Option 1):
- Elite D/ST units get rewarded with 1.05x multiplier
- Poor D/ST units get penalized with 0.95x multiplier
- Aligns with actual fantasy performance

### Backward Compatibility
- This changes D/ST scoring calculations
- May affect simulation results if team_quality WEIGHT > 0
- Currently WEIGHT = 0.0, so no immediate impact on recommendations
- When team_quality is enabled, this fix becomes critical

## Testing Requirements

1. Unit tests for new D/ST ranking calculation
2. Verify Houston D/ST gets EXCELLENT rating (rank 1-6)
3. Verify poor performing D/ST get POOR/VERY_POOR ratings
4. Integration test: full scoring calculation with D/ST
5. Regression test: ensure offensive player rankings unchanged

## Priority

**Medium-High** - This is a design flaw that produces incorrect results, but:
- Currently masked by WEIGHT = 0.0 (team quality disabled)
- Becomes critical when team quality scoring is re-enabled
- Affects simulation accuracy for parameter optimization

## Related Documentation

- `docs/scoring/04_team_quality_multiplier.md` - Should be updated to document D/ST-specific logic
- `ARCHITECTURE.md` - TeamDataManager section should note D/ST ranking method

## Example Test Case

```python
def test_dst_team_quality_uses_fantasy_points_scored():
    """D/ST team quality should be based on fantasy points scored, not points allowed."""
    # Setup: Houston D/ST (9.34 ppg season avg = #2 rank)
    houston_dst = create_dst_player(team='HOU', season_avg=9.34)

    # Calculate team quality multiplier
    score, reason = calculator._apply_team_quality_multiplier(houston_dst, 100.0)

    # Houston should be ranked in top 6 (EXCELLENT)
    assert 'EXCELLENT' in reason or 'GOOD' in reason
    assert score >= 100.0  # Should boost, not penalize

    # Should NOT be VERY_POOR (current incorrect behavior)
    assert 'VERY_POOR' not in reason
```

## Data Verification

Season-long D/ST Fantasy Rankings (Current Data):
1. SEA: 9.89 ppg (#1 - should be EXCELLENT)
2. HOU: 9.34 ppg (#2 - currently VERY_POOR ❌, should be EXCELLENT)
3. DEN: 7.52 ppg (#3 - should be EXCELLENT)
4. JAX: 7.39 ppg (#4 - should be EXCELLENT)
5. NE: 7.21 ppg (#5 - should be EXCELLENT)
6. CLE: 7.20 ppg (#6 - should be EXCELLENT)

Current (incorrect) defensive ranks by points_allowed:
1. PHI: 52.0 pts allowed
...
24. HOU: 116.6 pts allowed ← Houston ranked 24th (VERY_POOR)

This clearly shows the mismatch between actual D/ST fantasy performance (#2) and the incorrect team quality rating (VERY_POOR).

