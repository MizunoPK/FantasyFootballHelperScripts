===============================================================================
UPDATE SPECIFICATION: Fix Integration Test Failures
===============================================================================

OBJECTIVE: Fix 13 failing integration tests that are out of sync with refactored codebase

STATUS: NOT STARTED
PRIORITY: MEDIUM (All unit tests passing - integration tests are supplementary)
ESTIMATED EFFORT: 2-3 hours

===============================================================================
BACKGROUND
===============================================================================

After the major codebase refactoring, 13 integration tests are failing because they reference old APIs and class structures that no longer exist. The failures are:

1. test_data_fetcher_integration.py: 0/1 passing (import error)
2. test_league_helper_integration.py: 5/17 passing (API mismatches)
3. test_simulation_integration.py: 7/16 passing (config format issues)

These are PRE-EXISTING issues unrelated to recent unequal trade feature work.
All 1,786 unit tests are passing (100%), meeting commit requirements.

===============================================================================
CURRENT STATE
===============================================================================

Integration Test Results:
- Total: 34 integration tests
- Passing: 21 tests (61.8%)
- Failing: 13 tests (38.2%)

Unit Test Results:
- Total: 1,786 unit tests
- Passing: 1,786 tests (100%) ✅
- Failing: 0 tests

Key Issue: Integration tests written for OLD API before refactoring

===============================================================================
DETAILED ISSUES
===============================================================================

ISSUE 1: test_data_fetcher_integration.py (1 test file, 9 test methods)
------------------------------------------------------------------------

ERROR: ImportError: cannot import name 'PlayerDataFetcher'

Root Cause:
- Tests try to import: from player_data_fetcher_main import PlayerDataFetcher
- Actual class: NFLProjectionsCollector (completely different API)

Old API (what tests expect):
```python
fetcher = PlayerDataFetcher(output_dir=tmp_path)
fetcher.fetch_and_export()
```

New API (actual implementation):
```python
settings = Settings(
    season=2024,
    scoring_format=ScoringFormat.PPR,
    output_directory="data"
)
collector = NFLProjectionsCollector(settings)
projection_data = await collector.collect_all_projections()
output_files = await collector.export_data(projection_data)
```

Files Affected:
- tests/integration/test_data_fetcher_integration.py (lines 25, 46-78, 200-211)

Required Changes:
1. Update imports from PlayerDataFetcher → NFLProjectionsCollector
2. Update imports to include Settings, ScoringFormat
3. Rewrite all test fixtures to create Settings objects
4. Convert all test methods to async (new API is async)
5. Update all assertions to match new API return values
6. Update mock patches to target new class/method names

Test Methods to Fix (9 total):
- test_player_fetcher_initialization
- test_fetch_and_export_workflow
- test_player_data_can_be_exported_and_loaded
- test_player_fetcher_handles_api_errors
- test_scores_fetcher_handles_api_errors (similar NFLScoresFetcher issues)
- test_scores_fetcher_initialization
- test_scores_fetch_workflow
- test_player_config_loads_successfully (may work as-is)
- test_scores_config_loads_successfully (may work as-is)


ISSUE 2: test_league_helper_integration.py (12 failing tests)
--------------------------------------------------------------

ERROR 1: AttributeError: 'LeagueHelperManager' object has no attribute 'data_folder'
ERROR 2: AttributeError: 'PlayerManager' object has no attribute 'get_all_players'
ERROR 3: AttributeError: 'TeamDataManager' object has no attribute 'get_all_teams'

Root Cause: Tests use OLD API methods that were renamed/removed during refactoring

Old API (what tests expect):
```python
manager = LeagueHelperManager(data_folder)
manager.data_folder  # Doesn't exist
players = manager.player_manager.get_all_players()  # Method doesn't exist
teams = manager.team_data_manager.get_all_teams()  # Method doesn't exist
```

New API (actual implementation):
```python
manager = LeagueHelperManager(data_folder)
# data_folder stored internally but not exposed as public attribute
players = manager.player_manager.get_player_list()  # Renamed method
# TeamDataManager API changed - need to check actual methods
```

Files Affected:
- tests/integration/test_league_helper_integration.py

Required Changes:
1. Find actual public API for LeagueHelperManager (read source file)
2. Find actual public API for PlayerManager (read league_helper/util/PlayerManager.py)
3. Find actual public API for TeamDataManager (read league_helper/util/TeamDataManager.py)
4. Update all method calls throughout test file
5. Update all attribute accesses to use actual attributes
6. Fix test fixtures to create proper test data

Failing Test Methods (12 total):
- test_league_helper_initializes_with_valid_data_folder (line 98)
- test_league_helper_loads_player_data_on_init (line 105)
- test_league_helper_loads_team_data_on_init (line 115)
- test_add_to_roster_mode_can_be_entered (line 128)
- test_add_to_roster_workflow_adds_player (line 141)
- test_starter_helper_mode_can_be_entered (line 158)
- test_trade_simulator_mode_can_be_entered (line 177)
- test_modify_player_data_mode_can_be_entered (line 193)
- test_transition_from_add_to_roster_to_starter_helper (line 212)
- test_transition_from_add_to_roster_to_trade_simulator (line 225)
- test_player_data_persists_across_mode_transitions (line 239)
- test_team_data_persists_across_mode_transitions (line 254)


ISSUE 3: test_simulation_integration.py (9 failing tests)
----------------------------------------------------------

ERROR: ValueError: Config missing 'parameters' section

Root Cause: Tests create config files with OLD format (nested 'parameters' section)

Old Config Format (what tests create):
```json
{
  "config_name": "Test Config",
  "parameters": {
    "projected_points_multiplier": 1.0,
    "adp_multiplier_at_0": 1.5
  }
}
```

New Config Format (actual format):
```json
{
  "config_name": "Test Config",
  "description": "Test configuration",
  "current_nfl_week": 1,
  "scoring": { ... },
  "thresholds": {
    "projected_points_multiplier": 1.0,
    "adp_multipliers": [[0, 1.5], [50, 1.2], ...],
    "consistency_multipliers": { ... },
    "injury_penalties": { ... }
  },
  "roster_settings": { ... }
}
```

Files Affected:
- tests/integration/test_simulation_integration.py
- Fixture: baseline_config (lines ~60-75)

Required Changes:
1. Update baseline_config fixture to create config in NEW format
2. Look at actual league_config.json to see correct structure
3. Update all tests that create/modify config dictionaries
4. Update ConfigPerformance API calls (add_result → record_result or similar)
5. Check ConfigGenerator, SimulationManager API changes

Failing Test Methods (9 total):
- test_config_generator_loads_baseline (line 87)
- test_config_generator_creates_combinations (line 93)
- test_config_dict_has_required_fields (line 102)
- test_simulation_manager_initializes (line 117)
- test_simulation_manager_single_config_test (line 130)
- test_parallel_runner_can_run_simulations (line 164)
- test_config_performance_adds_results (line 248)
- test_config_performance_calculates_win_rate (line 264)
- test_complete_single_simulation_workflow (line 281)

===============================================================================
IMPLEMENTATION PLAN
===============================================================================

PHASE 1: Research Current APIs
-------------------------------
1. Read player-data-fetcher/player_data_fetcher_main.py to understand NFLProjectionsCollector API
2. Read league_helper/util/PlayerManager.py to understand current public methods
3. Read league_helper/util/TeamDataManager.py to understand current public methods
4. Read league_helper/LeagueHelperManager.py to understand current attributes
5. Read simulation/ConfigGenerator.py to understand current config format requirements
6. Read simulation/ConfigPerformance.py to understand current API (add_result vs record_result)
7. Read data/league_config.json to see actual config structure

PHASE 2: Fix test_data_fetcher_integration.py
----------------------------------------------
1. Update imports (PlayerDataFetcher → NFLProjectionsCollector, add Settings)
2. Create proper Settings fixtures for tests
3. Convert test methods to async (add async/await)
4. Update all mocks to target new class methods
5. Update assertions to match new return values
6. Run tests: python -m pytest tests/integration/test_data_fetcher_integration.py -v
7. Fix any remaining issues until all tests pass

PHASE 3: Fix test_league_helper_integration.py
-----------------------------------------------
1. Remove references to manager.data_folder (not a public attribute)
2. Replace get_all_players() with get_player_list() (or correct method name)
3. Replace get_all_teams() with correct method name from TeamDataManager
4. Update all attribute accesses to use actual public API
5. Fix temp_data_folder fixture to create all required files
6. Run tests: python -m pytest tests/integration/test_league_helper_integration.py -v
7. Fix issues one by one until all 17 tests pass

PHASE 4: Fix test_simulation_integration.py
--------------------------------------------
1. Update baseline_config fixture to use NEW config format
2. Copy structure from data/league_config.json
3. Update all tests that create/read config dictionaries
4. Find correct ConfigPerformance API method names
5. Update all method calls to match current API
6. Run tests: python -m pytest tests/integration/test_simulation_integration.py -v
7. Fix issues one by one until all 16 tests pass

PHASE 5: Final Validation
--------------------------
1. Run full integration test suite: python -m pytest tests/integration/ -v
2. Verify all 34 integration tests pass (100%)
3. Run full test suite: python tests/run_all_tests.py
4. Verify 1,811 total tests pass (100%)
5. Update this specification file → move to updates/done/

===============================================================================
SUCCESS CRITERIA
===============================================================================

1. All 34 integration tests passing (100%)
2. All 1,786 unit tests still passing (100%)
3. Total test count: 1,820/1,820 passing
4. No new warnings or errors introduced
5. Test execution time < 30 seconds for integration tests

===============================================================================
FILES TO MODIFY
===============================================================================

Primary Files:
1. tests/integration/test_data_fetcher_integration.py (~260 lines, 9 test methods)
2. tests/integration/test_league_helper_integration.py (~270 lines, 17 test methods)
3. tests/integration/test_simulation_integration.py (~300 lines, 16 test methods)

Reference Files (read-only, for API understanding):
1. player-data-fetcher/player_data_fetcher_main.py
2. league_helper/util/PlayerManager.py
3. league_helper/util/TeamDataManager.py
4. league_helper/LeagueHelperManager.py
5. simulation/ConfigGenerator.py
6. simulation/ConfigPerformance.py
7. data/league_config.json

Total Lines to Change: ~500-700 lines

===============================================================================
DEPENDENCIES
===============================================================================

None - This is standalone test fix work

===============================================================================
RISKS & MITIGATION
===============================================================================

RISK 1: Breaking working unit tests
MITIGATION: Run unit tests after each phase to ensure no regression

RISK 2: Integration tests reveal actual bugs in code
MITIGATION: If bugs found, fix the code (not just the tests)

RISK 3: API documentation is incomplete
MITIGATION: Read source code directly to understand actual APIs

===============================================================================
NOTES
===============================================================================

- All unit tests (1,786) are passing - integration tests are supplementary
- These failures existed BEFORE the unequal trade feature work
- Fixing these tests doesn't block any functionality
- Priority is MEDIUM because system works correctly (unit tests prove it)
- Integration tests are valuable for end-to-end validation but not blocking

===============================================================================
VALIDATION COMMANDS
===============================================================================

# Test individual files
python -m pytest tests/integration/test_data_fetcher_integration.py -v
python -m pytest tests/integration/test_league_helper_integration.py -v
python -m pytest tests/integration/test_simulation_integration.py -v

# Test all integration tests
python -m pytest tests/integration/ -v

# Test entire suite
python tests/run_all_tests.py

# Expected final output:
# ================================================================================
# SUCCESS: 1,820/1,820 TESTS PASSED (100%)
# ================================================================================

===============================================================================
END OF SPECIFICATION
===============================================================================
