================================================================================
WEEK-BY-WEEK CONFIG SIMULATION INTEGRATION
================================================================================

OVERVIEW
--------
The week-by-week config system (implemented in ConfigManager, ConfigPerformance,
ResultsManager) needs to be integrated with the simulation optimization system
(SimulationManager, ConfigGenerator) so that:

1. Simulations track per-week-range performance throughout optimization
2. Intermediate saves are folders with 4 config files (not single files)
3. Final output is a folder with 4 config files
4. Iterative mode can resume from folder-based checkpoints
5. Different optimal values are tracked per week range for week-specific params

--------------------------------------------------------------------------------

CURRENT STATE
-------------
ConfigManager:
  - Can load from folder structure (data/configs/) with 4 files
  - Merges week-specific params based on CURRENT_NFL_WEEK
  - Backward compatible with single-file legacy structure

ConfigPerformance:
  - Tracks per-week-range wins/losses/points (weeks 1-5, 6-11, 12-17)
  - add_week_results() updates both overall AND per-range tracking
  - get_win_rate_for_range() returns win rate for specific range

ResultsManager:
  - record_week_results() records per-week data
  - get_best_config_for_range() finds best config for a week range
  - get_best_configs_per_range() returns best for all three ranges
  - save_optimal_configs_folder() creates folder with 4 files
  - BASE_CONFIG_PARAMS and WEEK_SPECIFIC_PARAMS lists define param categories

SimulationManager (NOT YET UPDATED):
  - run_full_optimization() uses save_optimal_config() (single file)
  - run_iterative_optimization() saves optimal_iterative_{timestamp}.json
  - Intermediate files are single JSON files (intermediate_*.json)
  - Resume detection looks for intermediate_*.json files
  - Tracks single "current_optimal_config" during optimization

ConfigGenerator (NOT YET UPDATED):
  - load_baseline_config() loads single JSON file
  - No awareness of folder structure or week-specific params

ParallelLeagueRunner:
  - run_simulations_for_config_with_weeks() exists but not used by SimulationManager
  - Returns per-week results for tracking

--------------------------------------------------------------------------------

PROBLEM
-------
1. SimulationManager doesn't use per-week tracking methods
2. Intermediate saves are single files, not folders
3. Iterative mode tracks single "best" config instead of best-per-range
4. ConfigGenerator can't load baseline from folder structure
5. Week-specific params could have different optimal values per week range,
   but current system finds single optimal value for all weeks

Example of the problem:
  When optimizing PLAYER_RATING_SCORING_WEIGHT with values [1.0, 1.5, 2.0, 2.5, 3.0]:
  - Current: Finds single best value (e.g., 2.0) for all weeks
  - Desired: Find best per range:
    - Weeks 1-5: WEIGHT=2.5 might be best (early season, less data)
    - Weeks 6-11: WEIGHT=1.5 might be best (mid season)
    - Weeks 12-17: WEIGHT=3.0 might be best (playoff push)

--------------------------------------------------------------------------------

PROPOSED SOLUTION
-----------------

1. PARAMETER CLASSIFICATION

   Use existing ResultsManager lists to classify parameters:

   BASE_CONFIG_PARAMS (optimize for overall best, single value):
     - CURRENT_NFL_WEEK, NFL_SEASON, NFL_SCORING_FORMAT
     - NORMALIZATION_MAX_SCALE
     - SAME_POS_BYE_WEIGHT, DIFF_POS_BYE_WEIGHT
     - INJURY_PENALTIES
     - DRAFT_ORDER_BONUSES, DRAFT_ORDER, DRAFT_ORDER_FILE
     - MAX_POSITIONS, FLEX_ELIGIBLE_POSITIONS
     - ADP_SCORING

   WEEK_SPECIFIC_PARAMS (optimize per range, different values allowed):
     - PLAYER_RATING_SCORING
     - TEAM_QUALITY_SCORING
     - PERFORMANCE_SCORING
     - MATCHUP_SCORING
     - SCHEDULE_SCORING
     - TEMPERATURE_SCORING
     - WIND_SCORING
     - LOCATION_MODIFIERS

2. OPTIMIZATION LOGIC CHANGE

   Current (single optimal):
     for each parameter:
       test N values
       find overall best → update current_optimal_config

   New (per-range optimal):
     for each parameter:
       test N values
       if BASE param:
         find overall best → update league_config.json params
       if WEEK-SPECIFIC param:
         find best for 1-5 → update week1-5.json params
         find best for 6-11 → update week6-11.json params
         find best for 12-17 → update week12-17.json params

3. INTERMEDIATE SAVE STRUCTURE

   Current:
     simulation/optimal_configs/intermediate_01_NORMALIZATION.json
     simulation/optimal_configs/intermediate_02_ADP_WEIGHT.json

   New:
     simulation/optimal_configs/intermediate_01_NORMALIZATION/
       ├── league_config.json
       ├── week1-5.json
       ├── week6-11.json
       └── week12-17.json
     simulation/optimal_configs/intermediate_02_ADP_WEIGHT/
       ├── league_config.json
       ├── week1-5.json
       ├── week6-11.json
       └── week12-17.json

4. RESUME FROM FOLDER

   When resuming iterative optimization:
   - Detect most recent intermediate_*/ folder
   - Load all 4 files
   - Merge into working configs for continued optimization

--------------------------------------------------------------------------------

IMPLEMENTATION PLAN
-------------------

PHASE 1: ConfigGenerator Updates
--------------------------------
File: simulation/ConfigGenerator.py

1.1 Add parameter classification:
    - Import BASE_CONFIG_PARAMS and WEEK_SPECIFIC_PARAMS from ResultsManager
    - Add method is_base_param(param_name) -> bool
    - Add method is_week_specific_param(param_name) -> bool

1.2 Add folder loading:
    - Add load_baseline_from_folder(folder_path: Path) -> dict
    - Merges league_config.json with week-specific files
    - Returns unified config dict for optimization

1.3 Update __init__ to accept folder or file:
    - Detect if path is folder or file
    - Call appropriate loader

PHASE 2: SimulationManager Updates
-----------------------------------
File: simulation/SimulationManager.py

2.1 Update simulation execution:
    - Use run_simulations_for_config_with_weeks() instead of run_simulations_for_config()
    - Use record_week_results() instead of record_result()

2.2 Track multiple optimal configs:
    - Replace single current_optimal_config with:
      - current_base_config (for BASE params)
      - current_week_configs = {"1-5": {}, "6-11": {}, "12-17": {}}
    - Update after each parameter optimization

2.3 Update optimization logic:
    - For BASE params: find overall best, update current_base_config
    - For WEEK-SPECIFIC params: find best per range, update current_week_configs

2.4 Update intermediate saves:
    - Create folder instead of single file
    - Save 4 JSON files in folder
    - Use save_intermediate_folder() from ResultsManager

2.5 Update resume detection:
    - Look for intermediate_*/ folders instead of intermediate_*.json files
    - Load from folder structure

2.6 Update final save:
    - Use save_optimal_configs_folder() instead of save_optimal_config()

PHASE 3: ResultsManager Updates
-------------------------------
File: simulation/ResultsManager.py

3.1 Add save_intermediate_folder() method:
    - Similar to save_optimal_configs_folder() but with custom naming
    - Takes parameter name for folder naming
    - Returns folder path

3.2 Add load_configs_from_folder() method:
    - Loads all 4 files from a folder
    - Returns tuple of (base_config, week_configs_dict)

PHASE 4: Testing
----------------
Files: tests/simulation/test_*.py

4.1 ConfigGenerator tests:
    - test_load_baseline_from_folder
    - test_is_base_param
    - test_is_week_specific_param

4.2 SimulationManager tests:
    - test_iterative_with_per_week_tracking
    - test_intermediate_folder_save
    - test_resume_from_folder
    - test_base_param_optimization
    - test_week_specific_param_optimization

4.3 ResultsManager tests:
    - test_save_intermediate_folder
    - test_load_configs_from_folder

--------------------------------------------------------------------------------

DATA FLOW DIAGRAM
-----------------

Iterative Optimization with Week-by-Week Tracking:

┌─────────────────────────────────────────────────────────────────────────────┐
│                          ITERATIVE OPTIMIZATION                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────┐                                                        │
│  │ Load Baseline    │ ← folder or single file                                │
│  │ (ConfigGenerator)│                                                        │
│  └────────┬─────────┘                                                        │
│           │                                                                  │
│           ▼                                                                  │
│  ┌──────────────────┐                                                        │
│  │ Initialize:      │                                                        │
│  │ - base_config    │ (overall best for BASE params)                         │
│  │ - week_configs   │ (best per range for WEEK-SPECIFIC params)              │
│  └────────┬─────────┘                                                        │
│           │                                                                  │
│           ▼                                                                  │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ FOR EACH PARAMETER:                                                   │   │
│  │                                                                       │   │
│  │   ┌─────────────────┐                                                 │   │
│  │   │ Generate N      │                                                 │   │
│  │   │ variations      │                                                 │   │
│  │   └────────┬────────┘                                                 │   │
│  │            │                                                          │   │
│  │            ▼                                                          │   │
│  │   ┌─────────────────┐                                                 │   │
│  │   │ Run simulations │ → run_simulations_for_config_with_weeks()       │   │
│  │   │ with per-week   │                                                 │   │
│  │   │ tracking        │                                                 │   │
│  │   └────────┬────────┘                                                 │   │
│  │            │                                                          │   │
│  │            ▼                                                          │   │
│  │   ┌─────────────────────────────────────────────────────────────┐    │   │
│  │   │ IF BASE PARAM:                                               │    │   │
│  │   │   find overall best → update base_config                     │    │   │
│  │   │                                                              │    │   │
│  │   │ IF WEEK-SPECIFIC PARAM:                                      │    │   │
│  │   │   find best for 1-5   → update week_configs["1-5"]           │    │   │
│  │   │   find best for 6-11  → update week_configs["6-11"]          │    │   │
│  │   │   find best for 12-17 → update week_configs["12-17"]         │    │   │
│  │   └─────────────────────────────────────────────────────────────┘    │   │
│  │            │                                                          │   │
│  │            ▼                                                          │   │
│  │   ┌─────────────────┐                                                 │   │
│  │   │ Save intermediate│ → intermediate_XX_PARAM/                       │   │
│  │   │ folder           │    ├── league_config.json                      │   │
│  │   │                  │    ├── week1-5.json                            │   │
│  │   │                  │    ├── week6-11.json                           │   │
│  │   │                  │    └── week12-17.json                          │   │
│  │   └─────────────────┘                                                 │   │
│  │                                                                       │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│           │                                                                  │
│           ▼                                                                  │
│  ┌──────────────────┐                                                        │
│  │ Save final       │ → optimal_iterative_TIMESTAMP/                         │
│  │ folder           │    ├── league_config.json                              │
│  │                  │    ├── week1-5.json                                    │
│  │                  │    ├── week6-11.json                                   │
│  │                  │    └── week12-17.json                                  │
│  └──────────────────┘                                                        │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

--------------------------------------------------------------------------------

RESUME FLOW
-----------

When iterative optimization is interrupted and restarted:

1. Scan output_dir for intermediate_*/ folders
2. Find highest numbered folder (e.g., intermediate_15_MATCHUP_WEIGHT/)
3. Load all 4 files from that folder:
   - league_config.json → base_config
   - week1-5.json → week_configs["1-5"]
   - week6-11.json → week_configs["6-11"]
   - week12-17.json → week_configs["12-17"]
4. Resume optimization from parameter index 16

--------------------------------------------------------------------------------

BACKWARD COMPATIBILITY
----------------------

1. ConfigGenerator should still accept single JSON file as baseline
2. If baseline is single file, use it for all week ranges initially
3. Output is always folder structure (new format)
4. Old intermediate_*.json files are not compatible with new system
   - Could add migration utility if needed
   - Or just require fresh start if old intermediates detected

--------------------------------------------------------------------------------

OPEN QUESTIONS
--------------

Q1: Should full optimization mode also use per-week tracking?
    Recommendation: Yes, for consistency. Both modes should output folder structure.

Q2: What about run_single_config mode?
    Recommendation: Single config mode is for testing one config, not optimization.
    Could add optional per-week tracking but not required for folder output.

Q3: How to handle partially optimized week-specific params?
    Example: During PLAYER_RATING optimization, we might find:
    - weeks 1-5: WEIGHT=2.0 is best
    - weeks 6-11: still testing
    - weeks 12-17: WEIGHT=3.0 is best

    Recommendation: Optimization tests all values for all ranges simultaneously.
    Best per range is determined after all simulations complete for that param.

================================================================================
